<!DOCTYPE html>
<html>
<head>
  <title>Resume Pro</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 15px; width: 350px; }
    h2 { font-size: 18px; }
    button { padding: 8px; margin: 5px 0; cursor: pointer; }
    .keyword-tag {
      display: inline-block;
      background: #0073b1;
      color: white;
      padding: 5px 8px;
      margin: 3px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    #generatedTextBox, #keywordsBox { display: none; border: 1px solid #ccc; padding: 8px; margin-top: 8px; border-radius: 4px; }
  </style>
</head>
<body>

<h2>Upload Resume</h2>
<input type="file" id="resumeUpload" accept="application/pdf">

<h2>Cover Letter</h2>
<button id="generateCoverLetterBtn">Generate Tailored Cover Letter</button>
<div id="generatedTextBox">
  <strong>Generated Cover Letter:</strong>
  <pre id="generatedTextContent"></pre>
</div>

<h2>Relevant Keywords</h2>
<button id="extractKeywordsBtn">Extract Keywords for LinkedIn Search</button>
<div id="keywordsBox">
  <div id="keywordsContainer"></div>
  <button id="searchAllBtn" style="display:none; background:#0073b1; color:white;">Search All on LinkedIn</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
const apiKey = "YOUR_GEMINI_API_KEY"; // Replace with your Gemini key
window.fullResumeText = "";
window.extractedKeywords = [];

// PDF Upload
document.getElementById("resumeUpload").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function() {
    const typedarray = new Uint8Array(this.result);
    pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
      let fullText = "";
      let pagePromises = [];
      for (let i = 1; i <= pdf.numPages; i++) {
        pagePromises.push(
          pdf.getPage(i).then(function(page) {
            return page.getTextContent().then(function(textContent) {
              textContent.items.forEach(function(item) {
                fullText += item.str + " ";
              });
            });
          })
        );
      }
      Promise.all(pagePromises).then(function() {
        window.fullResumeText = fullText.trim();
        alert("Resume uploaded and processed!");
      });
    });
  };
  reader.readAsArrayBuffer(file);
});

// Generate Cover Letter
document.getElementById("generateCoverLetterBtn").addEventListener("click", async () => {
  if (!window.fullResumeText) {
    alert("Please upload a resume first.");
    return;
  }

  const prompt = `You are a professional career coach. Based on the following resume, write a tailored, concise, and professional cover letter for a job application. 
Make sure it emphasizes the candidate's relevant skills, experience, and achievements while keeping it under 300 words.
Resume content:
${window.fullResumeText}`;

  await callGeminiAPI(prompt, (text) => {
    document.getElementById("generatedTextContent").textContent = text;
    document.getElementById("generatedTextBox").style.display = "block";
  });
});

// Extract Keywords
document.getElementById("extractKeywordsBtn").addEventListener("click", async () => {
  if (!window.fullResumeText) {
    alert("Please upload a resume first.");
    return;
  }

  const prompt = `From the following resume, extract 5–10 short, highly relevant job search keywords or phrases that best describe the candidate’s target roles, skills, or industry expertise. 
Do not include generic words like "experience" or "team". 
Return them as a comma-separated list.
Resume:
${window.fullResumeText}`;

  await callGeminiAPI(prompt, (text) => {
    const keywords = text.split(",").map(k => k.trim()).filter(k => k.length);
    window.extractedKeywords = keywords;
    const container = document.getElementById("keywordsContainer");
    container.innerHTML = "";
    keywords.forEach(keyword => {
      const tag = document.createElement("span");
      tag.className = "keyword-tag";
      tag.textContent = keyword;
      tag.onclick = () => {
        const searchURL = `https://www.linkedin.com/jobs/search/?keywords=${encodeURIComponent(keyword)}`;
        window.open(searchURL, "_blank");
      };
      container.appendChild(tag);
    });
    if (keywords.length) {
      document.getElementById("searchAllBtn").style.display = "block";
    }
    document.getElementById("keywordsBox").style.display = "block";
  });
});

// Search All on LinkedIn
document.getElementById("searchAllBtn").addEventListener("click", () => {
  window.extractedKeywords.forEach(keyword => {
    const searchURL = `https://www.linkedin.com/jobs/search/?keywords=${encodeURIComponent(keyword)}`;
    window.open(searchURL, "_blank");
  });
});

// Common Gemini API Caller
async function callGeminiAPI(prompt, callback) {
  try {
    const model = "gemini-1.5-flash";
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      }
    );

    const data = await response.json();
    console.log("Gemini raw response:", data);

    if (data.error) {
      callback("❌ Gemini API Error: " + data.error.message);
      return;
    }

    let textOutput = "";
    if (data?.candidates?.length) {
      const candidate = data.candidates[0];
      if (candidate.content?.parts?.length) {
        textOutput = candidate.content.parts.map(p => p.text || "").join("\n");
      }
    }

    callback(textOutput || "⚠ Gemini API returned no text.");
  } catch (err) {
    callback("Error contacting Gemini API: " + err.message);
  }
}
</script>
</body>
</html>
