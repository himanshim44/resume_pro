<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Resume Job Finder — Keywords & LinkedIn Search</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{--primary:#0073b1;--accent:#10b981}
    body{font-family:Inter,Arial,Helvetica,sans-serif;margin:0;padding:14px;width:380px;background:#f3f4f6}
    h1{font-size:16px;margin:0 0 8px}
    p.sub { margin: 0 0 12px; color:#6b7280; font-size:13px }
    .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .row{display:flex;gap:8px;align-items:center}
    input[type="file"]{display:block;margin-bottom:8px}
    #resumeFileLabel{display:inline-block;padding:8px 10px;border-radius:6px;background:#eef2ff;color:#1f2937;cursor:pointer}
    .controls{margin-top:10px;display:flex;gap:8px}
    button{padding:8px 10px;border-radius:8px;border:0;cursor:pointer;background:var(--primary);color:white;font-weight:600}
    button.secondary{background:#6b7280}
    .small{font-size:13px;padding:6px 8px}
    .keywords { margin-top:10px; display:flex; flex-wrap:wrap; gap:6px; }
    .tag { padding:6px 9px; border-radius:999px; background:#e6eef6; color:var(--primary); cursor:pointer; user-select:none; font-size:13px; }
    .tag.selected { background:var(--primary); color:white; box-shadow:0 4px 10px rgba(2,6,23,0.08); transform:translateY(-1px); }
    label{font-size:13px;color:#374151}
    select,input[type="text"] { width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e5e7eb; }
    .section{margin-top:12px}
    #generatedBox{margin-top:10px;background:#fff;padding:10px;border-radius:8px;display:none;max-height:260px;overflow:auto}
    pre{white-space:pre-wrap;font-family:inherit;margin:0}
    .muted{font-size:13px;color:#6b7280;margin-top:6px}
    .controls-vertical{display:flex;flex-direction:column;gap:8px}
    .btn-export{background:var(--accent)}
  </style>
</head>
<body>
  <div class="card">
    <h1>Resume Job Finder</h1>
    <p class="sub">Upload resume → extract relevant keywords → search LinkedIn with filters</p>

    <div class="section">
      <label for="resumeInput">Upload resume (PDF)</label><br>
      <input id="resumeInput" type="file" accept="application/pdf" />
      <div id="resumeStatus" class="muted"></div>
    </div>

    <div class="section">
      <label>Keywords (Gemini)</label>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="extractKeywordsBtn" class="small">Extract Keywords</button>
        <button id="clearKeywordsBtn" class="small secondary">Clear</button>
      </div>
      <div id="keywords" class="keywords"></div>
      <div id="keywordsNotice" class="muted">Select one or more keywords to search.</div>
    </div>

    <div class="section">
      <label for="dateFilter">Date posted</label>
      <select id="dateFilter" class="small">
        <option value="">Any time</option>
        <option value="r86400">Past 24 hours</option>
        <option value="r604800">Past week</option>
        <option value="r2592000">Past month</option>
      </select>
    </div>

    <div class="section">
      <label for="locationInput">Location (optional)</label>
      <input id="locationInput" type="text" placeholder="e.g. San Francisco, United States" />
    </div>

    <div class="section controls">
      <button id="searchSelectedBtn" class="">Search Selected</button>
      <button id="openEachBtn" class="secondary">Open Each</button>
    </div>

    <div class="section" style="margin-top:10px;border-top:1px dashed #eef2f5;padding-top:10px">
      <label>Cover Letter</label>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="generateCoverBtn" class="small">Generate Cover Letter</button>
        <button id="exportPdfBtn" class="small btn-export" style="display:none">Export to PDF</button>
      </div>
      <div id="generatedBox"><strong>Cover Letter</strong><pre id="generatedText"></pre></div>
    </div>

    <div class="muted" style="margin-top:8px;font-size:12px">Tip: extract keywords first, then choose filters & search.</div>
  </div>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";</script>
  <!-- jsPDF for export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  /***** CONFIG: put your Gemini API key here ******/
  const apiKey = "YOUR_GEMINI_API_KEY_HERE";
  const geminiModel = "gemini-1.5-flash"; // works with most keys; change if needed
  /************************************************/

  // UI refs
  const resumeInput = document.getElementById('resumeInput');
  const resumeStatus = document.getElementById('resumeStatus');
  const extractBtn = document.getElementById('extractKeywordsBtn');
  const keywordsDiv = document.getElementById('keywords');
  const clearKeywordsBtn = document.getElementById('clearKeywordsBtn');
  const dateFilter = document.getElementById('dateFilter');
  const locationInput = document.getElementById('locationInput');
  const searchSelectedBtn = document.getElementById('searchSelectedBtn');
  const openEachBtn = document.getElementById('openEachBtn');
  const generateCoverBtn = document.getElementById('generateCoverBtn');
  const generatedBox = document.getElementById('generatedBox');
  const generatedText = document.getElementById('generatedText');
  const exportPdfBtn = document.getElementById('exportPdfBtn');

  // State
  window.fullResumeText = "";
  window.extractedKeywords = []; // array of {text, selected}

  // Helper: show error/status
  function setStatus(msg) { resumeStatus.textContent = msg; }
  function clearStatus() { resumeStatus.textContent = ""; }

  // Read PDF and extract full text
  resumeInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    setStatus('Reading PDF...');
    try {
      const arrayBuffer = await file.arrayBuffer();
      const typed = new Uint8Array(arrayBuffer);
      const pdf = await pdfjsLib.getDocument(typed).promise;
      let full = "";
      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const txt = await page.getTextContent();
        full += txt.items.map(i => i.str).join(" ") + " ";
      }
      window.fullResumeText = full.trim();
      setStatus('Resume loaded. ' + Math.max(0, window.fullResumeText.length) + ' chars extracted.');
      // clear old keywords and cover letter
      window.extractedKeywords = [];
      renderKeywords();
      generatedBox.style.display = 'none';
      exportPdfBtn.style.display = 'none';
    } catch (err) {
      console.error(err);
      setStatus('Failed to read PDF: ' + err.message);
      window.fullResumeText = "";
    }
  });

  // Render keywords as selectable bubbles
  function renderKeywords() {
    keywordsDiv.innerHTML = "";
    window.extractedKeywords.forEach((k, idx) => {
      const span = document.createElement('span');
      span.className = 'tag' + (k.selected ? ' selected' : '');
      span.textContent = k.text;
      span.onclick = () => {
        window.extractedKeywords[idx].selected = !window.extractedKeywords[idx].selected;
        renderKeywords();
      };
      keywordsDiv.appendChild(span);
    });
    if (!window.extractedKeywords.length) {
      keywordsDiv.innerHTML = '<div class="muted" style="font-size:13px;color:#9ca3af">No keywords yet — extract from resume.</div>';
    }
  }

  clearKeywordsBtn.addEventListener('click', () => {
    window.extractedKeywords = [];
    renderKeywords();
  });

  // Ask Gemini to extract 5-10 relevant keywords/phrases (comma-separated)
  extractBtn.addEventListener('click', async () => {
    if (!window.fullResumeText) { alert('Please upload a resume first.'); return; }
    setStatus('Asking Gemini for relevant keywords...');
    try {
      const prompt = `From the following resume, extract 5–10 short, highly relevant job search keywords or phrases (roles, skills, tools, domains) that best describe the candidate’s target roles and expertise. 
Do NOT include generic words like "experience", "team", "work". Return the result as a comma-separated list (no numbering).
Resume:
${window.fullResumeText}`;
      const text = await callGemini(prompt);
      if (!text) {
        setStatus('Gemini returned no keywords.');
        return;
      }
      // parse comma-separated robustly (also handle newlines)
      let parts = text.split(/\n|,/).map(s => s.trim()).filter(Boolean);
      // remove duplicates & short words
      const seen = new Set();
      parts = parts.map(p => p.replace(/^[\d\.\-\)\s]+/, '').trim()).filter(p => p.length>1 && !seen.has((p=p.toLowerCase()))) .map(p => { seen.add(p); return p; });
      // Map back to original-cased display (capitalize words)
      const display = parts.map(p => p.split(/\s+/).map(w => w[0]?.toUpperCase()+w.slice(1)).join(' ')).slice(0,10);
      window.extractedKeywords = display.map(t => ({ text: t, selected: true })); // default selected
      renderKeywords();
      setStatus('Keywords extracted — tweak selection then search.');
    } catch (err) {
      console.error(err);
      setStatus('Keyword extraction failed: ' + (err.message || err));
    }
  });

  // Build LinkedIn search URL from selected keywords + filters
  function buildLinkedInUrl(keywordsArray) {
    const keywords = keywordsArray.join(' ');
    const loc = locationInput.value.trim();
    const date = dateFilter.value; // e.g. r86400
    const params = new URLSearchParams();
    if (keywords) params.set('keywords', keywords);
    if (loc) params.set('location', loc);
    // LinkedIn uses f_TPR param for time range filter
    let url = 'https://www.linkedin.com/jobs/search/?' + params.toString();
    if (date) {
      // add f_TPR param after existing params
      url += (params.toString() ? '&' : '') + 'f_TPR=' + encodeURIComponent(date);
    }
    return url;
  }

  // Search Selected (one combined search)
  searchSelectedBtn.addEventListener('click', () => {
    const selected = window.extractedKeywords.filter(k => k.selected).map(k => k.text);
    if (!selected.length) { alert('Please select at least one keyword.'); return; }
    const url = buildLinkedInUrl(selected);
    window.open(url, '_blank');
  });

  // Open Each keyword in its own tab
  openEachBtn.addEventListener('click', () => {
    const selected = window.extractedKeywords.filter(k => k.selected).map(k => k.text);
    if (!selected.length) { alert('Please select at least one keyword.'); return; }
    selected.forEach(k => {
      const url = buildLinkedInUrl([k]);
      window.open(url, '_blank');
    });
  });

  // Generate Cover Letter using full resume text
  generateCoverBtn.addEventListener('click', async () => {
    if (!window.fullResumeText) { alert('Please upload a resume first.'); return; }
    setStatus('Generating cover letter...');
    const prompt = `You are a professional career coach. Based on the following resume, write a tailored, concise, and professional cover letter for a job application. 
Keep it under 300 words and emphasize the candidate's most relevant skills, achievements, and measurable impact. Use a confident, professional tone.
Resume:
${window.fullResumeText}`;
    try {
      const text = await callGemini(prompt);
      generatedText.textContent = text || "No text returned.";
      generatedBox.style.display = 'block';
      exportPdfBtn.style.display = text ? 'inline-block' : 'none';
      setStatus('Cover letter generated.');
    } catch (err) {
      console.error(err);
      setStatus('Cover letter generation failed: ' + (err.message || err));
    }
  });

  // Export cover letter to PDF (jsPDF)
  exportPdfBtn.addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'letter' });
    const margin = 40;
    const pageWidth = doc.internal.pageSize.getWidth() - margin*2;
    const text = generatedText.textContent || '';
    const lines = doc.splitTextToSize(text, pageWidth);
    doc.setFontSize(12);
    doc.text(lines, margin, 60);
    doc.save('cover_letter.pdf');
  });

  // Utility: call Gemini and parse responses robustly
  async function callGemini(prompt) {
    if (!apiKey || apiKey === "YOUR_GEMINI_API_KEY_HERE") {
      throw new Error('No Gemini API key configured. Put your key in the script (apiKey).');
    }
    const body = {
      contents: [{ parts: [{ text: prompt }] }]
    };
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${apiKey}`;
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    console.log('Gemini raw response:', data);
    if (data.error) {
      throw new Error(data.error.message || JSON.stringify(data.error));
    }
    // robust parsing:
    let text = "";
    if (data?.candidates?.length) {
      const cand = data.candidates[0];
      if (cand.content?.parts?.length) {
        text = cand.content.parts.map(p => p.text || "").join("\n");
      } else if (cand.output) {
        text = cand.output;
      }
    } else if (data?.output?.[0]?.content?.parts?.length) {
      // fallback structure (rare)
      text = data.output[0].content.parts.map(p => p.text || "").join("\n");
    } else if (data?.output?.[0]?.content) {
      text = JSON.stringify(data.output[0].content);
    }
    return (text || "").trim();
  }

  // initial render
  renderKeywords();
  </script>
</body>
</html>
